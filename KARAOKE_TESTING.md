# Karaoke Subtitle Feature - Testing Instructions

## Quick Test Guide

Follow these steps to test the new karaoke subtitle feature.

## Prerequisites

1. Poetry environment set up
2. faster-whisper installed (should be in dependencies)
3. FFmpeg with libass support (for video rendering)
4. Test audio file (e.g., "Gift of The Magi.mp3")

## Test 1: Basic Karaoke Generation

### Command (Linux/Mac)

```bash
cd /home/user/audiobook-pipeline-chatterbox/phase5_enhancement

poetry run python -m phase5_enhancement.subtitles \
  --audio "../Gift of The Magi.mp3" \
  --file-id "Gift_of_The_Magi_Test" \
  --output-dir "subtitles" \
  --model small \
  --karaoke
```

### Expected Output

```
=== Phase 5.5: Subtitle Generation ===
Initializing Whisper model: small
Model loaded in X.XXs
Audio duration: XXX.XXs (XX.X minutes)
Starting transcription...
Detected language: en (confidence: 0.XX)
Transcription complete: XXX segments in XX.XXs
Processing segments for subtitle display...
Processed XXX subtitle segments
Validating subtitle quality...
Saving subtitle files...
Saved SRT: subtitles/Gift_of_The_Magi_Test.srt
Saved VTT: subtitles/Gift_of_The_Magi_Test.vtt
Initialized KaraokeGenerator with font: Arial 32px
Karaoke ASS generation complete:
  Segments: XXX
  Words: XXXX
  Avg word duration: X.XXXs
Saved karaoke ASS: subtitles/Gift_of_The_Magi_Test_karaoke.ass
Saved metrics: subtitles/Gift_of_The_Magi_Test_metrics.json
=== Subtitle generation complete in XX.XXs ===
Coverage: XX.XX%
Segments: XXX
Karaoke mode: ENABLED (ASS file generated)

âœ… Subtitles generated successfully!
SRT: subtitles/Gift_of_The_Magi_Test.srt
VTT: subtitles/Gift_of_The_Magi_Test.vtt
ASS (Karaoke): subtitles/Gift_of_The_Magi_Test_karaoke.ass

Metrics:
  Coverage: XX.XX%
  Segments: XXX
  Karaoke words: XXXX
  Avg word duration: X.XXXs
  Processing time: XX.Xs
```

### Verify Files Created

```bash
ls -lh subtitles/Gift_of_The_Magi_Test*
```

Expected files:
- `Gift_of_The_Magi_Test.srt`
- `Gift_of_The_Magi_Test.vtt`
- `Gift_of_The_Magi_Test_karaoke.ass` â† NEW!
- `Gift_of_The_Magi_Test_metrics.json`

## Test 2: Inspect ASS File Format

### Check ASS File Structure

```bash
head -50 subtitles/Gift_of_The_Magi_Test_karaoke.ass
```

### Expected Format

```ini
[Script Info]
; Karaoke-style subtitles for ELL (English Language Learner) content
; Generated by Phase 5.5 Subtitle Generator with Karaoke Support
ScriptType: v4.00+
PlayResX: 1920
PlayResY: 1080
...

[V4+ Styles]
Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, ...
Style: Default,Arial,32,&H00FFFFFF,&H00FFFF00,&H00000000,&H00000000,1,0,0,0,100,100,0,0,1,3,2,2,10,10,80,1

[Events]
Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
Dialogue: 0,0:00:00.00,0:00:05.25,Default,,0,0,0,,{\k45}One {\k30}dollar {\k35}and {\k40}eighty-seven {\k45}cents.
Dialogue: 0,0:00:05.50,0:00:10.75,Default,,0,0,0,,{\k25}That {\k20}was {\k30}all.
...
```

### Verify Karaoke Tags

Look for `{\k##}` tags before each word:
- `{\k45}One` = word "One" highlights for 0.45 seconds
- Duration should match audio timing

### Check Color Codes

- PrimaryColour: `&H00FFFFFF` (white)
- SecondaryColour: `&H00FFFF00` (yellow)

## Test 3: Check Metrics JSON

```bash
cat subtitles/Gift_of_The_Magi_Test_metrics.json | python -m json.tool
```

### Expected Fields

```json
{
  "coverage": 0.98,
  "last_timestamp": 1234.56,
  "timestamp_drift": 0.12,
  "drift_corrected": false,
  "wer": null,
  "segment_count": 245,
  "avg_segment_duration": 4.5,
  "avg_segment_length": 65,
  "max_segment_length": 84,
  "karaoke_enabled": true,
  "karaoke_stats": {
    "total_segments": 245,
    "total_words": 1250,
    "avg_word_duration": 0.45,
    "output_path": "subtitles/Gift_of_The_Magi_Test_karaoke.ass"
  },
  "processing_time": 125.3,
  "status": "success"
}
```

## Test 4: Render Test Video (Short Clip)

### Create 30-second Test

```bash
# Extract first 30 seconds of audio for quick testing
ffmpeg -i "Gift of The Magi.mp3" -t 30 -c copy test_30sec.mp3

# Generate karaoke subtitles for test clip
cd phase5_enhancement
poetry run python -m phase5_enhancement.subtitles \
  --audio "../test_30sec.mp3" \
  --file-id "Test_30sec" \
  --output-dir "subtitles" \
  --model small \
  --karaoke
```

### Render Test Video

```bash
cd ..
ffmpeg -y \
  -f lavfi -i color=c=black:s=1920x1080:r=25 \
  -i test_30sec.mp3 \
  -vf "ass=phase5_enhancement/subtitles/Test_30sec_karaoke.ass" \
  -c:v libx264 -c:a copy -shortest -pix_fmt yuv420p \
  test_karaoke_30sec.mp4
```

### Verify Video

```bash
# Play the video
ffplay test_karaoke_30sec.mp4

# Or open in your video player
```

**What to look for:**
- âœ… Words appear at bottom center
- âœ… Each word highlights YELLOW as it's spoken
- âœ… Words turn WHITE after being spoken
- âœ… Text is readable (Arial 32px, bold, black outline)
- âœ… Timing matches audio (Â±50ms tolerance)

## Test 5: Full Video Generation with Script

### Standard Subtitles

```bash
./generate_gift_of_magi_video.ps1
```

### Karaoke Subtitles

```bash
./generate_gift_of_magi_video.ps1 -Karaoke
```

### Expected Output

```
==== Gift of The Magi - ELL Video Generator ====
Mode: KARAOKE (Word-by-word highlighting)

[1/4] Checking audio file...
  âœ“ Found: C:\Users\myson\Pipeline\audiobook-pipeline-chatterbox\Gift of The Magi.mp3

[2/4] Generating subtitles with faster-whisper...
  Karaoke mode enabled - generating word-level timestamps...
  Command: poetry run python -m phase5_enhancement.subtitles ...
  ...

[3/4] Subtitle Quality Metrics:
  Coverage: 98.5%

[4/4] Creating ELL-optimized video with hardcoded subtitles...
  Font: Arial (32px)
  Style: Karaoke word-by-word highlighting (yellow -> white)
  Rendering video (this may take 5-10 minutes)...
  âœ“ Video created: C:\Users\myson\Pipeline\audiobook-pipeline-chatterbox\Gift_of_The_Magi_ELL_KARAOKE.mp4

==== SUCCESS ====

Output Files:
  Subtitles (SRT): ...subtitles\Gift_of_The_Magi.srt
  Subtitles (VTT): ...subtitles\Gift_of_The_Magi.vtt
  Subtitles (ASS): ...subtitles\Gift_of_The_Magi_karaoke.ass
                   ^ Karaoke-style word highlighting!
  Final Video:     ...Gift_of_The_Magi_ELL_KARAOKE.mp4
```

## Test 6: Backward Compatibility

### Test Without --karaoke Flag

```bash
cd phase5_enhancement
poetry run python -m phase5_enhancement.subtitles \
  --audio "../test_30sec.mp3" \
  --file-id "Test_NoKaraoke" \
  --output-dir "subtitles" \
  --model small
# Note: NO --karaoke flag
```

### Expected Behavior

- âœ… Should work exactly as before
- âœ… Generates SRT and VTT only (no ASS)
- âœ… No word-level timestamp extraction
- âœ… Metrics show `"karaoke_enabled": false`

## Test 7: Error Handling

### Test 1: Missing Audio File

```bash
poetry run python -m phase5_enhancement.subtitles \
  --audio "nonexistent.mp3" \
  --file-id "test" \
  --karaoke
```

**Expected**: Error message about missing file

### Test 2: Invalid Model

```bash
poetry run python -m phase5_enhancement.subtitles \
  --audio "../test_30sec.mp3" \
  --file-id "test" \
  --model invalid \
  --karaoke
```

**Expected**: Argument error (model must be tiny/small/base)

## Success Criteria

All tests pass if:

- [x] `--karaoke` flag works without errors
- [x] ASS file generated with proper format
- [x] ASS file contains `{\k##}` timing tags
- [x] Word-level timing present in ASS file
- [x] Video renders with word highlighting
- [x] Highlighting color: yellow â†’ white transition
- [x] Styling matches ELL requirements (Arial 32px, high contrast)
- [x] Compatible with existing pipeline (SRT/VTT still generated)
- [x] Metrics JSON includes karaoke statistics
- [x] Video generator script detects and uses ASS files
- [x] Backward compatibility: works without --karaoke flag

## Performance Benchmarks

Expected processing times (Gift of The Magi ~30 minutes):

| Model | Without Karaoke | With Karaoke | Difference |
|-------|----------------|--------------|------------|
| tiny  | 3-5 min        | 4-6 min      | +15-20%    |
| small | 8-12 min       | 10-14 min    | +10-15%    |
| base  | 15-20 min      | 17-23 min    | +10-15%    |

## Troubleshooting

### Issue: "No module named 'subtitle_karaoke'"

**Solution**: Ensure you're in the poetry environment:
```bash
cd phase5_enhancement
poetry install
poetry run python -m phase5_enhancement.subtitles --help
```

### Issue: ASS file shows no highlighting in video

**Solution**: Make sure you're using the `ass` filter (not `subtitles`):
```bash
# Correct:
-vf "ass=file.ass"

# Wrong (doesn't render karaoke):
-vf "subtitles=file.ass"
```

### Issue: Words highlight too fast/slow

**Diagnosis**: Check word timestamps in ASS file:
```bash
grep "Dialogue:" subtitles/Test_karaoke.ass | head -5
```

If durations look wrong, verify faster-whisper word-level data extraction.

## Next Steps After Testing

1. âœ… Verify all tests pass
2. ðŸ“¹ Preview full-length karaoke video
3. ðŸŽ¨ Adjust styling if needed (colors, font size)
4. ðŸ“Š Compare engagement metrics (standard vs karaoke)
5. ðŸš€ Deploy to production pipeline

## Report Issues

If any test fails, gather:
1. Full command used
2. Error message/output
3. Python version: `python --version`
4. faster-whisper version: `poetry show faster-whisper`
5. FFmpeg version: `ffmpeg -version`
6. Sample ASS file (first 50 lines)
